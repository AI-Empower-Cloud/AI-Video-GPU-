# ðŸš€ AI GPU Studio - Azure Deployment via GitHub Actions
# Complete website deployment to Azure with GPU support

name: Deploy to Azure

on:
  push:
    branches: [ main ]
  workflow_dispatch:
    inputs:
      environment:
        description: 'Deployment Environment'
        required: true
        default: 'production'
        type: choice
        options:
          - production
          - staging

env:
  AZURE_RESOURCE_GROUP: ai-gpu-studio-rg
  AZURE_LOCATION: eastus
  AZURE_WEBAPP_NAME: ai-gpu-studio
  AZURE_CONTAINER_REGISTRY: aigpustudio
  NODE_VERSION: '20'
  PYTHON_VERSION: '3.11'

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    environment: ${{ github.event.inputs.environment || 'production' }}
    
    steps:
    - name: ðŸ” Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: ðŸ” Azure Login
      uses: azure/login@v1
      with:
        creds: ${{ secrets.AZURE_CREDENTIALS }}

    - name: ðŸ—ï¸ Set up Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'npm'
        cache-dependency-path: frontend/package-lock.json

    - name: ðŸ Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}

    - name: ðŸ“¦ Install Frontend Dependencies
      run: |
        cd frontend
        npm ci
        npm run build

    - name: ðŸ“¦ Install Backend Dependencies
      run: |
        pip install -r requirements.txt
        pip install -r requirements-dev.txt

    - name: ðŸ§ª Run Tests
      run: |
        cd frontend && npm test -- --watchAll=false
        python -m pytest tests/ -v

    - name: ðŸ—ï¸ Create Azure Resources
      run: |
        # Create Resource Group
        az group create \
          --name ${{ env.AZURE_RESOURCE_GROUP }} \
          --location ${{ env.AZURE_LOCATION }}

        # Create Container Registry
        az acr create \
          --resource-group ${{ env.AZURE_RESOURCE_GROUP }} \
          --name ${{ env.AZURE_CONTAINER_REGISTRY }} \
          --sku Basic \
          --admin-enabled true

        # Create App Service Plan (Linux)
        az appservice plan create \
          --name ai-gpu-studio-plan \
          --resource-group ${{ env.AZURE_RESOURCE_GROUP }} \
          --location ${{ env.AZURE_LOCATION }} \
          --is-linux \
          --sku P1V3

        # Create Web App
        az webapp create \
          --resource-group ${{ env.AZURE_RESOURCE_GROUP }} \
          --plan ai-gpu-studio-plan \
          --name ${{ env.AZURE_WEBAPP_NAME }} \
          --runtime "NODE:20-lts"

    - name: ðŸ³ Build and Push Docker Images
      run: |
        # Login to ACR
        az acr login --name ${{ env.AZURE_CONTAINER_REGISTRY }}
        
        # Build and push frontend
        docker build -t ${{ env.AZURE_CONTAINER_REGISTRY }}.azurecr.io/frontend:latest \
          -f frontend/Dockerfile frontend/
        docker push ${{ env.AZURE_CONTAINER_REGISTRY }}.azurecr.io/frontend:latest
        
        # Build and push backend
        docker build -t ${{ env.AZURE_CONTAINER_REGISTRY }}.azurecr.io/backend:latest \
          -f Dockerfile .
        docker push ${{ env.AZURE_CONTAINER_REGISTRY }}.azurecr.io/backend:latest

    - name: ðŸš€ Deploy to Azure Web App
      uses: azure/webapps-deploy@v2
      with:
        app-name: ${{ env.AZURE_WEBAPP_NAME }}
        images: ${{ env.AZURE_CONTAINER_REGISTRY }}.azurecr.io/frontend:latest

    - name: âš™ï¸ Configure App Settings
      run: |
        az webapp config appsettings set \
          --resource-group ${{ env.AZURE_RESOURCE_GROUP }} \
          --name ${{ env.AZURE_WEBAPP_NAME }} \
          --settings \
            WEBSITES_ENABLE_APP_SERVICE_STORAGE=false \
            DOCKER_REGISTRY_SERVER_URL=https://${{ env.AZURE_CONTAINER_REGISTRY }}.azurecr.io \
            DOCKER_REGISTRY_SERVER_USERNAME=$(az acr credential show --name ${{ env.AZURE_CONTAINER_REGISTRY }} --query username -o tsv) \
            DOCKER_REGISTRY_SERVER_PASSWORD=$(az acr credential show --name ${{ env.AZURE_CONTAINER_REGISTRY }} --query passwords[0].value -o tsv) \
            NODE_ENV=production \
            PORT=8000

    - name: ðŸ¥ Health Check
      run: |
        # Wait for deployment
        sleep 60
        
        # Check if site is accessible
        SITE_URL="https://${{ env.AZURE_WEBAPP_NAME }}.azurewebsites.net"
        echo "ðŸ” Checking site health: $SITE_URL"
        
        if curl -f -s $SITE_URL > /dev/null; then
          echo "âœ… Site is healthy and accessible"
        else
          echo "âŒ Site health check failed"
          exit 1
        fi

    - name: ðŸ“Š Deployment Summary
      run: |
        echo "ðŸŽ‰ Azure Deployment Complete!"
        echo "ðŸ“Š Deployment Summary:"
        echo "â”œâ”€â”€ Resource Group: ${{ env.AZURE_RESOURCE_GROUP }}"
        echo "â”œâ”€â”€ Location: ${{ env.AZURE_LOCATION }}"
        echo "â”œâ”€â”€ Web App: ${{ env.AZURE_WEBAPP_NAME }}"
        echo "â”œâ”€â”€ Container Registry: ${{ env.AZURE_CONTAINER_REGISTRY }}"
        echo "â””â”€â”€ Site URL: https://${{ env.AZURE_WEBAPP_NAME }}.azurewebsites.net"
        
        # Save deployment info
        cat > deployment-info.json << EOF
        {
          "timestamp": "$(date -u +%Y-%m-%dT%H:%M:%SZ)",
          "environment": "${{ github.event.inputs.environment || 'production' }}",
          "resource_group": "${{ env.AZURE_RESOURCE_GROUP }}",
          "webapp_name": "${{ env.AZURE_WEBAPP_NAME }}",
          "site_url": "https://${{ env.AZURE_WEBAPP_NAME }}.azurewebsites.net",
          "commit_sha": "${{ github.sha }}",
          "commit_message": "${{ github.event.head_commit.message }}"
        }
        EOF

    - name: ðŸ“ Upload Deployment Artifacts
      uses: actions/upload-artifact@v3
      with:
        name: deployment-info
        path: deployment-info.json
